name: Deploy Application

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Pull latest changes
        run: |
          git fetch origin main
          git reset --hard origin/main
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=${{ vars.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT=${{ vars.POSTGRES_PORT }}
          
          REDIS_PORT=${{ vars.REDIS_PORT }}
          
          MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}
          MINIO_PORT=${{ vars.MINIO_PORT }}
          MINIO_CONSOLE_PORT=${{ vars.MINIO_CONSOLE_PORT }}
          MINIO_BUCKET_DATASETS=${{ vars.MINIO_BUCKET_DATASETS }}
          MINIO_BUCKET_RESULTS=${{ vars.MINIO_BUCKET_RESULTS }}
          MINIO_BUCKET_EXPORTS=${{ vars.MINIO_BUCKET_EXPORTS }}
          EXPORT_RETENTION_DAYS=${{ vars.EXPORT_RETENTION_DAYS }}
          
          DATABASE_URL=postgresql+psycopg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:${{ vars.POSTGRES_PORT }}/${{ vars.POSTGRES_DB }}
          REDIS_URL=redis://redis:${{ vars.REDIS_PORT }}/0
          MINIO_ENDPOINT=minio:${{ vars.MINIO_PORT }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_SECURE=${{ vars.MINIO_SECURE }}
          MAX_UPLOAD_BYTES=${{ vars.MAX_UPLOAD_BYTES }}
          ALLOWED_CORS_ORIGINS=${{ vars.ALLOWED_CORS_ORIGINS }}
          STUCK_JOB_TIMEOUT_MINUTES=${{ vars.STUCK_JOB_TIMEOUT_MINUTES }}
          MC_PARALLEL_ENABLED=${{ vars.MC_PARALLEL_ENABLED }}
          MC_MAX_PROCESSES=${{ vars.MC_MAX_PROCESSES }}
          MC_BATCH_SIZE=${{ vars.MC_BATCH_SIZE }}
          WS_HEARTBEAT_SECONDS=${{ vars.WS_HEARTBEAT_SECONDS }}
          
          BACKEND_PORT=${{ vars.BACKEND_PORT }}
          FRONTEND_PORT=${{ vars.FRONTEND_PORT }}
          VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL }}
          EOF
      
      - name: Pull latest Docker images
        run: docker compose pull
      
      - name: Deploy with Docker Compose
        run: |
          docker compose down --remove-orphans
          docker compose up -d --build
      
      - name: Clean up old Docker images
        run: docker image prune -f
      
      - name: Health check
        run: |
          echo "Waiting for services to be healthy..."
          sleep 10
          # Check if containers are running
          if [ $(docker compose ps -q | wc -l) -eq 0 ]; then
            echo "No containers are running!"
            docker compose logs
            exit 1
          fi
          echo "Deployment successful!"
