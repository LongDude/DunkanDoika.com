name: Deploy Application

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Pull latest changes
        run: |
          git fetch origin main
          git reset --hard origin/main
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
          
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          
          MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}
          MINIO_PORT=${{ secrets.MINIO_PORT }}
          MINIO_CONSOLE_PORT=${{ secrets.MINIO_CONSOLE_PORT }}
          MINIO_BUCKET_DATASETS=${{ secrets.MINIO_BUCKET_DATASETS }}
          MINIO_BUCKET_RESULTS=${{ secrets.MINIO_BUCKET_RESULTS }}
          MINIO_BUCKET_EXPORTS=${{ secrets.MINIO_BUCKET_EXPORTS }}
          EXPORT_RETENTION_DAYS=${{ secrets.EXPORT_RETENTION_DAYS }}
          
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_SECURE=${{ secrets.MINIO_SECURE }}
          MAX_UPLOAD_BYTES=${{ secrets.MAX_UPLOAD_BYTES }}
          ALLOWED_CORS_ORIGINS=${{ secrets.ALLOWED_CORS_ORIGINS }}
          STUCK_JOB_TIMEOUT_MINUTES=${{ secrets.STUCK_JOB_TIMEOUT_MINUTES }}
          MC_PARALLEL_ENABLED=${{ secrets.MC_PARALLEL_ENABLED }}
          MC_MAX_PROCESSES=${{ secrets.MC_MAX_PROCESSES }}
          MC_BATCH_SIZE=${{ secrets.MC_BATCH_SIZE }}
          WS_HEARTBEAT_SECONDS=${{ secrets.WS_HEARTBEAT_SECONDS }}
          
          BACKEND_PORT=${{ secrets.BACKEND_PORT }}
          FRONTEND_PORT=${{ secrets.FRONTEND_PORT }}
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          EOF
      
      - name: Pull latest Docker images
        run: docker compose pull
      
      - name: Deploy with Docker Compose
        run: |
          docker compose down --remove-orphans
          docker compose up -d --build
      
      - name: Clean up old Docker images
        run: docker image prune -f
      
      - name: Health check
        run: |
          echo "Waiting for services to be healthy..."
          sleep 10
          # Check if containers are running
          if [ $(docker compose ps -q | wc -l) -eq 0 ]; then
            echo "No containers are running!"
            docker compose logs
            exit 1
          fi
          echo "Deployment successful!"
